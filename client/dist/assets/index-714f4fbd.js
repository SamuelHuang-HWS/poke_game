import{r as G,o as D,c as b,a as U,d as R,b as O,e as N,f as $,g as V}from"./vendor-7103c11f.js";import{a as q,l as x}from"./utils-3f3b5d51.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const B=(r,e)=>{const t=r.__vccOpts||r;for(const[o,s]of e)t[o]=s;return t},M={name:"App"},j={id:"app"};function J(r,e,t,o,s,n){const i=G("router-view");return D(),b("div",j,[U(i)])}const F=B(M,[["render",J]]),H="modulepreload",z=function(r){return"/"+r},S={},f=function(e,t,o){if(!t||t.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(t.map(n=>{if(n=z(n),n in S)return;S[n]=!0;const i=n.endsWith(".css"),k=i?'[rel="stylesheet"]':"";if(!!o)for(let l=s.length-1;l>=0;l--){const h=s[l];if(h.href===n&&(!i||h.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${k}`))return;const a=document.createElement("link");if(a.rel=i?"stylesheet":H,i||(a.as="script",a.crossOrigin=""),a.href=n,document.head.appendChild(a),i)return new Promise((l,h)=>{a.addEventListener("load",l),a.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>e()).catch(n=>{const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=n,window.dispatchEvent(i),!i.defaultPrevented)throw n})};class W{setToken(e){localStorage.setItem("token",e)}getToken(){return localStorage.getItem("token")}removeToken(){localStorage.removeItem("token")}isAuthenticated(){const e=this.getToken();if(!e)return!1;try{return JSON.parse(atob(e.split(".")[1])).exp*1e3>Date.now()}catch{return this.removeToken(),!1}}getUserInfo(){const e=this.getToken();if(!e)return null;try{const t=JSON.parse(atob(e.split(".")[1]));return{userId:t.userId,phoneNumber:t.phoneNumber}}catch{return null}}setUserInfo(e){localStorage.setItem("userInfo",JSON.stringify(e))}getUserInfoFromStorage(){try{const e=localStorage.getItem("userInfo");return e?JSON.parse(e):null}catch{return null}}removeUserInfo(){localStorage.removeItem("userInfo")}clearAuth(){this.removeToken(),this.removeUserInfo()}}const u=new W,c=q.create({baseURL:"http://localhost:3000/api",timeout:1e4});c.interceptors.request.use(r=>{const e=u.getToken();return e&&(r.headers.Authorization=`Bearer ${e}`),r},r=>Promise.reject(r));c.interceptors.response.use(r=>r,async r=>{const{response:e}=r;return e&&e.status===401&&(L().logout(),window.location.href="/login"),Promise.reject(r)});class K{async register(e,t,o){return c.post("/auth/register",{username:e,phoneNumber:t,password:o})}async login(e){return c.post("/auth/login",e)}async getProfile(){return c.get("/auth/profile")}async checkAuth(){return c.get("/auth/check")}async updateProfile(e){return c.put("/auth/profile",e)}}const g=new K,L=R("auth",{state:()=>({user:null,token:u.getToken()||null,isAuthenticated:!1,lastCheckTime:0}),getters:{isLoggedIn:r=>!!r.token},actions:{async register(r,e,t,o){try{const s=await g.register(r,e,t),{user:n,token:i}=s.data;return this.user=n,this.token=i,this.isAuthenticated=!0,this.lastCheckTime=Date.now(),u.setToken(i),s}catch(s){throw s}},async login(r,e,t){try{const o=await g.login({phoneNumber:r,password:e,deviceId:t}),{user:s,token:n}=o.data.data;return this.user=s,this.token=n,this.isAuthenticated=!0,this.lastCheckTime=Date.now(),u.setToken(n),o}catch(o){throw o}},async fetchUser(){if(this.token)try{const r=await g.getProfile();return this.user=r.data.data,this.isAuthenticated=!0,this.lastCheckTime=Date.now(),u.setUserInfo(r.data.data),r}catch(r){throw this.logout(),r}},async updateUser(r){try{const e=await g.updateProfile(r);return this.user=e.data.data,this.lastCheckTime=Date.now(),u.setUserInfo(e.data.data),e}catch(e){throw e}},logout(){this.user=null,this.token=null,this.isAuthenticated=!1,this.lastCheckTime=0,u.clearAuth()},async checkAuth(r=!1){if(!this.token)return this.logout(),!1;const e=5*60*1e3;if(!r&&Date.now()-this.lastCheckTime<e&&u.isAuthenticated())return!0;try{const t=await g.checkAuth();return this.user=t.data.data,this.isAuthenticated=!0,this.lastCheckTime=Date.now(),u.setUserInfo(t.data.data),!0}catch{return this.logout(),!1}}}});class Q{async startGame(e){return c.post("/games/start",e)}async seeCards(e){return c.post("/games/see",e)}async call(e){return c.post("/games/call",e)}async raise(e){return c.post("/games/raise",e)}async fold(e){return c.post("/games/fold",e)}async compare(e){return c.post("/games/compare",e)}async getGameDetail(e){return c.get(`/games/${e}`)}}const m=new Q;class X{constructor(){this.socket=null,this.isConnected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectDelay=1e3,this.isReconnecting=!1,this.currentRoomId=null,this.currentUserId=null,this.eventListeners=new Map}connect(e,t={}){return this.socket&&this.disconnect(),this.socket=x(e,{transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:this.reconnectDelay,reconnectionDelayMax:5e3,timeout:1e4,forceNew:!0,...t}),this.socket.on("connect",()=>{this.isConnected=!0,this.reconnectAttempts=0,this.isReconnecting=!1,this.currentRoomId&&this.currentUserId&&(console.log("重连成功，重新加入房间"),this.emit("user_join",{userId:this.currentUserId,roomId:this.currentRoomId}))}),this.socket.on("disconnect",o=>{this.isConnected=!1,console.log("Socket断开连接:",o),o==="io server disconnect"&&this.reconnect()}),this.socket.on("connect_error",o=>{console.error("Socket.IO连接错误:",o),this.isConnected=!1}),this.socket.on("player_offline",o=>{console.log("玩家离线:",o)}),this.socket.on("player_reconnected",o=>{console.log("玩家重连:",o)}),this.socket.on("creator_changed",o=>{console.log("房主已转移:",o)}),this.socket.on("room_disbanded",o=>{console.log("房间已解散:",o),this.currentRoomId=null,this.currentUserId=null}),this.socket}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.isConnected=!1,this.currentRoomId=null,this.currentUserId=null,this.eventListeners.clear())}setCurrentRoom(e,t){this.currentRoomId=e,this.currentUserId=t}clearCurrentRoom(){this.currentRoomId=null,this.currentUserId=null}emit(e,t){if(!this.isConnected){console.warn("Socket: Not connected, cannot emit event",{event:e,data:t});return}console.log("Socket: Emit",{event:e,data:t}),this.socket.emit(e,t)}on(e,t){if(!this.socket){console.warn("Socket: Not initialized, cannot listen to event",{event:e});return}this.socket.on(e,t)}off(e,t){this.socket&&this.socket.off(e,t)}getStatus(){return{connected:this.isConnected,id:this.socket?this.socket.id:null}}delay(e){return new Promise(t=>setTimeout(t,e))}async reconnect(){if(!this.isReconnecting){for(this.isReconnecting=!0;this.reconnectAttempts<this.maxReconnectAttempts;)try{await this.delay(this.reconnectDelay),this.socket.disconnected&&this.socket.connect(),await new Promise((e,t)=>{const o=setTimeout(()=>{t(new Error("Reconnect timeout"))},5e3);this.socket.once("connect",()=>{clearTimeout(o),e()})}),this.isReconnecting=!1;return}catch{this.reconnectAttempts++,this.reconnectDelay=Math.min(this.reconnectDelay*2,3e4)}this.isReconnecting=!1}}}const d=new X,Y=R("game",{state:()=>({socket:null,currentGame:null,isConnected:!1,isLoading:!1,error:null}),getters:{isInGame:r=>!!r.currentGame},actions:{initSocket(){this.socket||(this.socket=d,this.isConnected=d.getStatus().connected)},async startGame(r){try{this.isLoading=!0,this.error=null;const e=await m.startGame({roomId:r});return this.currentGame=e.data.data,e}catch(e){throw this.error=e.message||"开始游戏失败",e}finally{this.isLoading=!1}},async seeCards(r){try{this.isLoading=!0,this.error=null;const e=await m.seeCards({gameId:r});return this.currentGame=e.data.data,e}catch(e){throw this.error=e.message||"看牌失败",e}finally{this.isLoading=!1}},async call(r){try{this.isLoading=!0,this.error=null;const e=await m.call({gameId:r});return this.currentGame=e.data.data,e}catch(e){throw this.error=e.message||"跟注失败",e}finally{this.isLoading=!1}},async raise(r,e){try{this.isLoading=!0,this.error=null;const t=await m.raise({gameId:r,amount:e});return this.currentGame=t.data.data,t}catch(t){throw this.error=t.message||"加注失败",t}finally{this.isLoading=!1}},async fold(r){try{this.isLoading=!0,this.error=null;const e=await m.fold({gameId:r});return this.currentGame=e.data.data,e}catch(e){throw this.error=e.message||"弃牌失败",e}finally{this.isLoading=!1}},async compare(r,e){try{this.isLoading=!0,this.error=null;const t=await m.compare({gameId:r,targetUserId:e});return this.currentGame=t.data.data,t}catch(t){throw this.error=t.message||"比牌失败",t}finally{this.isLoading=!1}},async fetchGameDetail(r){try{this.isLoading=!0,this.error=null;const e=await m.getGameDetail(r);return this.currentGame=e.data.data,e.data.data}catch(e){throw this.error=e.message||"获取游戏详情失败",e}finally{this.isLoading=!1}},disconnectSocket(){this.socket&&(this.socket.disconnect(),this.socket=null,this.isConnected=!1)}}}),Z=()=>f(()=>import("./Login-3868877a.js"),["assets/Login-3868877a.js","assets/vendor-7103c11f.js","assets/utils-3f3b5d51.js","assets/Login-c45ca424.css"]),ee=()=>f(()=>import("./Register-d3883f67.js"),["assets/Register-d3883f67.js","assets/vendor-7103c11f.js","assets/utils-3f3b5d51.js","assets/Register-28d376ce.css"]),te=()=>f(()=>import("./Home-fbd40d5b.js"),["assets/Home-fbd40d5b.js","assets/vendor-7103c11f.js","assets/room-9fddfd0e.js","assets/utils-3f3b5d51.js","assets/Home-2b89bfeb.css"]),re=()=>f(()=>import("./RoomList-13304a41.js"),["assets/RoomList-13304a41.js","assets/vendor-7103c11f.js","assets/room-9fddfd0e.js","assets/utils-3f3b5d51.js","assets/RoomList-b398692e.css"]),oe=()=>f(()=>import("./CreateRoom-e9f57307.js"),["assets/CreateRoom-e9f57307.js","assets/vendor-7103c11f.js","assets/room-9fddfd0e.js","assets/utils-3f3b5d51.js","assets/CreateRoom-d0c5dacb.css"]),se=()=>f(()=>import("./GameRoom-d7ac80a3.js"),["assets/GameRoom-d7ac80a3.js","assets/vendor-7103c11f.js","assets/room-9fddfd0e.js","assets/utils-3f3b5d51.js","assets/GameRoom-004af9ac.css"]),ne=()=>f(()=>import("./Profile-383aa323.js"),["assets/Profile-383aa323.js","assets/vendor-7103c11f.js","assets/utils-3f3b5d51.js","assets/Profile-227f87b9.css"]);function p(r,e,t){localStorage.getItem("token")?t():t("/login")}function A(r,e,t){localStorage.getItem("token")?t("/"):t()}const ie=[{path:"/",name:"Home",component:te,beforeEnter:p},{path:"/login",name:"Login",component:Z,beforeEnter:A},{path:"/register",name:"Register",component:ee,beforeEnter:A},{path:"/rooms",name:"RoomList",component:re,beforeEnter:p},{path:"/rooms/create",name:"CreateRoom",component:oe,beforeEnter:p},{path:"/rooms/:roomId",name:"GameRoom",component:se,beforeEnter:p,props:!0},{path:"/profile",name:"Profile",component:ne,beforeEnter:p}],E=O({history:N(),routes:ie});E.beforeEach(async(r,e,t)=>{var i,k,y;const o=L(),s=Y();if(r.matched.some(a=>a.beforeEnter===p)){if(!o.token||!u.isAuthenticated()){o.logout(),t("/login");return}if(!o.user){const a=u.getUserInfoFromStorage();a&&(o.user=a,o.isAuthenticated=!0)}if(s.isInGame&&s.currentGame){const l=s.currentGame.roomId,h=`/rooms/${l}`;if(r.path!==h){console.log("路由守卫: 检测到用户在游戏中，自动跳转到游戏房间",{roomId:l,from:r.path,to:h}),t(h);return}if(!d.getStatus().connected)try{const _="http://localhost:3000";d.connect(_),await new Promise((C,T)=>{let w=0;const P=50,v=setInterval(()=>{w++,d.getStatus().connected?(clearInterval(v),C()):w>=P&&(clearInterval(v),T(new Error("Socket连接超时")))},100)}),d.setCurrentRoom(l,(i=o.user)==null?void 0:i.id),d.emit("user_join",{userId:(k=o.user)==null?void 0:k.id,roomId:l}),console.log("路由守卫: 已重新连接游戏房间",{roomId:l,userId:(y=o.user)==null?void 0:y.id})}catch(_){console.error("路由守卫: Socket重连失败",_)}}t()}else t()});const I=$(F),ce=V();I.use(ce);I.use(E);I.mount("#app");export{B as _,Y as a,c as b,d as s,L as u};
