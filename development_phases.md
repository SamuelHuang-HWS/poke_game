# 牌类游戏平台开发阶段规划

## 概述
为了更好地管理和控制项目进度，我们将庞大的需求拆分为四个开发阶段，每个阶段都有明确的目标和交付内容。这样可以确保我们优先实现核心功能，快速验证产品可行性，并逐步扩展功能。

## 第一期：核心功能开发（MVP）
### 目标
实现炸金花游戏的基本可玩性，验证核心玩法和经济系统，完成最小可行产品。

### 功能列表

#### 1. 用户系统

##### 1.1 用户注册流程
**流程步骤：**
1. 客户端进入注册页面
2. 用户输入手机号（11位数字）
3. 用户设置密码（6-16位，包含字母和数字）
4. 用户确认密码
5. 客户端验证两次密码一致性
6. 客户端获取设备唯一标识（设备ID）
7. 客户端发送注册请求（手机号、密码、设备ID）
8. 服务端验证手机号格式
9. 服务端验证手机号是否已注册
10. 服务端验证设备ID是否已注册（同设备防多开）
11. 服务端对密码进行加密（bcrypt加盐）
12. 服务端生成用户唯一ID（UUID）
13. 服务端创建用户记录（用户ID、手机号、加密密码、设备ID、创建时间、初始金币10000）
14. 服务端生成用户Token（JWT，有效期7天）
15. 服务端返回注册成功（用户ID、Token、初始金币）
16. 客户端存储Token到本地存储
17. 客户端跳转到游戏大厅

**异常处理：**
- 手机号格式错误：提示"请输入正确的手机号"
- 手机号已注册：提示"该手机号已注册"
- 设备已注册：提示"该设备已注册账号"
- 密码格式错误：提示"密码需6-16位，包含字母和数字"
- 两次密码不一致：提示"两次密码输入不一致"
- 网络错误：提示"网络连接失败，请稍后重试"

**后续需求：**
- 短信验证码功能（需要接入第三方短信服务，产生费用，暂不实现）

##### 1.2 用户登录流程
**流程步骤：**
1. 客户端进入登录页面
2. 用户输入手机号（11位数字）
3. 用户输入密码
4. 客户端发送登录请求（手机号、密码）
5. 服务端验证手机号格式
6. 服务端查询用户记录
7. 服务端验证用户是否存在
8. 服务端验证密码是否正确（bcrypt比对）
9. 服务端更新用户最后登录时间
10. 服务端生成新Token（JWT，有效期7天）
11. 服务端返回登录成功（用户ID、Token、金币数、昵称）
12. 客户端存储Token到本地存储
13. 客户端跳转到游戏大厅

**异常处理：**
- 手机号格式错误：提示"请输入正确的手机号"
- 用户不存在：提示"账号不存在，请先注册"
- 密码错误：提示"密码错误"
- 网络错误：提示"网络连接失败，请稍后重试"

##### 1.3 同设备防多开机制
**流程步骤：**
1. 用户首次注册时，客户端获取设备唯一标识（设备ID）
2. 客户端将设备ID发送到服务端
3. 服务端验证设备ID是否已绑定其他账号
4. 如果设备ID已绑定，拒绝注册
5. 如果设备ID未绑定，将设备ID与用户ID绑定存储
6. 登录时不校验设备ID，允许换设备登录

**设备ID获取方式：**
- iOS：使用Vendor Identifier（IDFV）
- Android：使用Android ID
- Web：使用浏览器指纹（Canvas指纹 + UserAgent + 屏幕分辨率）

**说明：**
- 注册时校验设备ID，防止同一设备注册多个账号
- 登录时不校验设备ID，允许用户换设备登录
- 设备ID仅用于注册时的防多开限制

##### 1.4 基础用户信息存储
**数据结构：**
```json
{
  "userId": "UUID",
  "phone": "13800138000",
  "password": "bcrypt加密后的密码",
  "deviceId": "设备唯一标识",
  "nickname": "玩家" + userId后4位, // 玩家昵称，默认"玩家"+后4位用户ID 注册可设置 可以自定义修改
  "avatar": "默认头像URL",
  "coins": 10000,
  "createTime": "2025-01-01 00:00:00",
  "lastLoginTime": "2025-01-01 12:00:00",
  "totalGames": 0,
  "totalWins": 0
}
```

#### 2. 游戏核心功能

##### 2.1 发牌系统流程
**流程步骤：**
1. 游戏开始前，服务端初始化一副牌（52张，不含大小王）
2. 牌的表示：花色（0-3：黑桃、红桃、梅花、方块）+ 点数（2-14：2-10、J、Q、K、A）
3. 服务端使用Fisher-Yates算法对牌组进行随机洗牌
4. 服务端为每个玩家生成3张牌
5. 服务端将每个玩家的牌存储到内存中（Redis，设置过期时间1小时）
6. 服务端记录每个玩家的牌型（用于后续比牌）
7. 服务端向客户端发送发牌消息（不包含牌面，只显示牌背）
8. 客户端显示牌背动画
9. 玩家点击"看牌"按钮时，客户端发送看牌请求
10. 服务端验证请求是否来自当前玩家
11. 服务端返回该玩家的牌面信息
12. 客户端显示牌面（已看牌标记）

**洗牌算法（Fisher-Yates）：**
```
for i from 51 down to 1:
    j = random integer with 0 <= j <= i
    swap cards[i] and cards[j]
```

##### 2.2 牌型判断流程
**牌型优先级（从高到低）：**
1. 豹子（三张相同点数）
2. 同花顺（同花色且连续）
3. 同花（同花色）
4. 顺子（连续）
5. 对子（两张相同点数）
6. 单张（其他情况）

**牌型判断流程：**
1. 接收3张牌作为输入
2. 将牌按点数从大到小排序
3. 判断是否为豹子：三张牌点数相同
4. 判断是否为同花顺：花色相同 + 点数连续（A-2-3特殊处理为最小顺子）
5. 判断是否为同花：三张牌花色相同
6. 判断是否为顺子：点数连续（A-2-3特殊处理为最小顺子）
7. 判断是否为对子：两张牌点数相同
8. 其他情况为单张
9. 返回牌型类型和牌型值（用于比牌）

**牌型值计算：**
- 豹子：6000 + 点数（A=14，2=2）
- 同花顺：5000 + 最大牌点数
- 同花：4000 + 最大牌点数*100 + 第二大牌点数*10 + 最小牌点数
- 顺子：3000 + 最大牌点数
- 对子：2000 + 对子点数*100 + 单张点数
- 单张：最大牌点数*100 + 第二大牌点数*10 + 最小牌点数

##### 2.3 游戏操作流程

**2.3.1 看牌流程**
1. 玩家轮到自己操作时，点击"看牌"按钮
2. 客户端发送看牌请求（房间ID、玩家ID）
3. 服务端验证玩家是否在房间内
4. 服务端验证是否轮到该玩家操作
5. 服务端验证玩家是否已经看过牌
6. 服务端返回玩家的牌面信息
7. 客户端显示牌面（翻开动画）
8. 客户端标记玩家为"已看牌"状态
9. 服务端记录玩家已看牌状态

**2.3.2 跟注流程**
1. 玩家轮到自己操作时，点击"跟注"按钮
2. 客户端发送跟注请求（房间ID、玩家ID）
3. 服务端验证玩家是否在房间内
4. 服务端验证是否轮到该玩家操作
5. 服务端验证玩家金币是否足够（未看牌玩家跟注金额=当前单注，已看牌玩家跟注金额=当前单注×2）
6. 服务端扣除玩家金币
7. 服务端增加当前轮次总注池
8. 服务端记录玩家跟注金额
9. 服务端将操作权交给下一位玩家
10. 服务端向所有玩家广播跟注消息（玩家ID、跟注金额、当前注池）
11. 客户端更新注池显示
12. 客户端高亮下一位玩家

**2.3.3 加注流程**
1. 玩家轮到自己操作时，点击"加注"按钮
2. 客户端显示加注选项（当前单注的2倍、3倍、5倍）
3. 玩家选择加注倍数
4. 客户端发送加注请求（房间ID、玩家ID、加注倍数）
5. 服务端验证玩家是否在房间内
6. 服务端验证是否轮到该玩家操作
7. 服务端验证玩家金币是否足够（未看牌玩家加注金额=当前单注×倍数，已看牌玩家加注金额=当前单注×倍数×2）
8. 服务端更新当前单注为加注金额
9. 服务端扣除玩家金币
10. 服务端增加当前轮次总注池
11. 服务端记录玩家加注金额
12. 服务端将操作权交给下一位玩家
13. 服务端向所有玩家广播加注消息（玩家ID、加注金额、当前单注、当前注池）
14. 客户端更新单注和注池显示
15. 客户端高亮下一位玩家

**2.3.4 弃牌流程**
1. 玩家轮到自己操作时，点击"弃牌"按钮
2. 客户端发送弃牌请求（房间ID、玩家ID）
3. 服务端验证玩家是否在房间内
4. 服务端验证是否轮到该玩家操作
5. 服务端标记玩家为"已弃牌"状态
6. 服务端将玩家从当前轮次移除
7. 服务端判断剩余玩家数量
8. 如果剩余玩家=1，触发结算流程
9. 如果剩余玩家>1，将操作权交给下一位玩家
10. 服务端向所有玩家广播弃牌消息（玩家ID）
11. 客户端标记该玩家为"已弃牌"
12. 客户端高亮下一位玩家

**2.3.5 比牌流程**
1. 玩家轮到自己操作时，点击"比牌"按钮
2. 客户端显示可比牌的玩家列表（除自己和已弃牌玩家）
3. 玩家选择要比牌的目标玩家
4. 客户端发送比牌请求（房间ID、玩家ID、目标玩家ID）
5. 服务端验证玩家是否在房间内
6. 服务端验证是否轮到该玩家操作
7. 服务端验证目标玩家是否有效（未弃牌、不是自己）
8. 服务端验证玩家金币是否足够（未看牌玩家比牌费用=当前单注×2，已看牌玩家比牌费用=当前单注×4）
9. 服务端扣除玩家金币
10. 服务端增加当前轮次总注池
11. 服务端获取两个玩家的牌型
12. 服务端比较两个玩家的牌型值
13. 服务端判断输赢（牌型值大者获胜）
14. 服务端标记输家为"已弃牌"状态
15. 服务端向所有玩家广播比牌结果（玩家ID、目标玩家ID、结果）
16. 服务端判断剩余玩家数量
17. 如果剩余玩家=1，触发结算流程
18. 如果剩余玩家>1，将操作权交给下一位玩家
19. 客户端显示比牌结果动画
20. 客户端标记输家为"已弃牌"
21. 客户端高亮下一位玩家

##### 2.4 游戏流程控制

**2.4.1 入桌流程**
1. 玩家在房间列表中选择一个房间
2. 客户端发送入桌请求（房间ID、玩家ID）
3. 服务端验证房间是否存在
4. 服务端验证房间是否已满（最多6人）
5. 服务端验证玩家是否已在房间内
6. 服务端将玩家添加到房间玩家列表
7. 服务端为玩家分配座位号（1-6）
8. 服务端向房间内所有玩家广播入桌消息（玩家ID、座位号、昵称、头像）
9. 客户端显示新玩家入桌动画
10. 客户端更新座位显示
11. 服务端判断房间人数是否达到游戏开始条件（至少2人）
12. 如果满足条件，服务端开始倒计时（10秒）
13. 客户端显示倒计时
14. 倒计时结束后，服务端触发游戏开始流程

**2.4.2 游戏开始流程**
1. 服务端生成游戏局ID
2. 服务端设置游戏状态为"进行中"
3. 服务端设置初始单注（单注倍数×100）
4. 服务端初始化注池（0）
5. 服务端执行发牌流程
6. 服务端随机选择庄家（座位号）
7. 服务端设置当前操作玩家为庄家下一位
8. 服务端设置当前轮次为1
9. 服务端向所有玩家广播游戏开始消息（局ID、庄家、当前玩家、单注、注池）
10. 客户端显示游戏开始动画
11. 客户端更新注池和单注显示
12. 客户端高亮当前玩家
13. 客户端显示操作按钮（看牌、跟注、加注、弃牌、比牌）

**2.4.3 回合流程**
1. 服务端等待当前玩家操作（超时时间30秒）
2. 如果玩家超时未操作，服务端自动执行弃牌操作
3. 服务端处理玩家操作（看牌、跟注、加注、弃牌、比牌）
4. 服务端判断是否所有玩家都已操作过
5. 如果所有玩家都已操作过，服务端增加轮次
6. 服务端判断是否达到最大轮次（15轮）
7. 如果达到最大轮次，服务端触发强制比牌流程
8. 服务端将操作权交给下一位玩家
9. 服务端向所有玩家广播回合信息（当前玩家、轮次）
10. 客户端更新轮次显示
11. 客户端高亮当前玩家

**2.4.4 结算流程**
1. 服务端判断游戏结束条件（剩余1人 或 达到最大轮次）
2. 如果剩余1人，该玩家直接获胜
3. 如果达到最大轮次，服务端执行强制比牌流程
   3.1 获取所有未弃牌玩家的牌
   3.2 比较所有玩家的牌型值
   3.3 找出牌型值最大的玩家
   3.4 该玩家获胜
4. 服务端计算抽水金额（注池的5%）
5. 服务端计算玩家获得金额（注池 - 抽水）
6. 服务端增加获胜玩家金币
7. 服务端更新玩家统计数据（总游戏数、总胜局）
8. 服务端记录游戏日志（局ID、所有玩家、操作记录、结果）
9. 服务端向所有玩家广播结算消息（获胜玩家、获得金额、抽水金额、各玩家牌型）
10. 客户端显示结算界面（获胜玩家、牌型、获得金额）
11. 客户端更新玩家金币显示
12. 服务端判断房间局数是否达到设定值
13. 如果达到设定值，服务端触发房间结算流程
14. 如果未达到设定值，服务端开始下一局倒计时（5秒）
15. 倒计时结束后，服务端触发游戏开始流程

**2.4.5 下一局流程**
1. 服务端生成新游戏局ID
2. 服务端设置游戏状态为"进行中"
3. 服务端设置庄家为上一局庄家的下一位
4. 服务端设置初始单注（单注倍数×100）
5. 服务端初始化注池（0）
6. 服务端执行发牌流程
7. 服务端设置当前操作玩家为庄家下一位
8. 服务端设置当前轮次为1
9. 服务端向所有玩家广播下一局开始消息（局ID、庄家、当前玩家、单注、注池）
10. 客户端显示下一局开始动画
11. 客户端更新注池和单注显示
12. 客户端高亮当前玩家
13. 客户端显示操作按钮（看牌、跟注、加注、弃牌、比牌）

##### 2.5 强制比牌流程
1. 服务端获取所有未弃牌玩家
2. 服务端获取每个玩家的牌
3. 服务端计算每个玩家的牌型值
4. 服务端按牌型值从大到小排序
5. 服务端找出牌型值最大的玩家
6. 服务端标记该玩家为获胜者
7. 服务端向所有玩家广播强制比牌结果（所有玩家牌型、获胜者）

##### 2.6 异常处理流程

**2.6.1 玩家断开连接处理流程**
**流程步骤：**
1. 服务端检测到玩家WebSocket连接断开
2. 服务端判断玩家是否在房间内
3. 如果玩家不在房间内，流程结束
4. 服务端判断房间游戏状态（等待中/进行中）
5. 如果游戏状态为"等待中"：
   5.1 服务端从房间玩家列表中移除该玩家
   5.2 服务端释放该玩家座位号
   5.3 服务端向房间内所有玩家广播玩家离开消息（玩家ID、昵称）
   5.4 客户端更新玩家列表显示
   5.5 服务端判断房间是否为空
   5.6 如果房间为空，服务端删除房间记录
   5.7 如果房间不为空且该玩家是房主，服务端将房主权限转移给下一位玩家
6. 如果游戏状态为"进行中"：
   6.1 服务端标记该玩家为"离线"状态
   6.2 服务端记录玩家断开时间
   6.3 服务端向房间内所有玩家广播玩家离线消息（玩家ID、昵称）
   6.4 客户端标记该玩家为"离线"状态（显示灰色头像）
   6.5 服务端启动离线超时计时器（60秒）
   6.6 服务端判断该玩家是否是当前操作玩家
   6.7 如果是当前操作玩家，服务端等待超时后自动执行弃牌操作
   6.8 如果不是当前操作玩家，服务端等待超时后执行弃牌操作
   6.9 超时后，服务端将该玩家标记为"已弃牌"
   6.10 服务端向房间内所有玩家广播玩家弃牌消息（玩家ID）
   6.11 客户端标记该玩家为"已弃牌"状态
   6.12 服务端判断游戏是否结束（剩余1人）
   6.13 如果游戏结束，服务端触发结算流程
   6.14 如果游戏未结束，服务端继续游戏流程

**2.6.2 玩家主动退出房间流程**
**流程步骤：**
1. 玩家在房间界面点击"退出房间"按钮
2. 客户端判断房间游戏状态（等待中/进行中）
3. 如果游戏状态为"等待中"：
   3.1 客户端发送退出房间请求（玩家ID、房间ID）
   3.2 服务端验证玩家是否在房间内
   3.3 服务端从房间玩家列表中移除该玩家
   3.4 服务端释放该玩家座位号
   3.5 服务端向房间内所有玩家广播玩家离开消息（玩家ID、昵称）
   3.6 客户端更新玩家列表显示
   3.7 服务端判断房间是否为空
   3.8 如果房间为空，服务端删除房间记录
   3.9 如果房间不为空且该玩家是房主，服务端将房主权限转移给下一位玩家
   3.10 服务端返回退出成功
   3.11 客户端跳转到游戏大厅
4. 如果游戏状态为"进行中"：
   4.1 客户端显示确认弹窗"游戏进行中，退出将视为弃牌，是否确认退出？"
   4.2 如果玩家点击"取消"，流程结束
   4.3 如果玩家点击"确认"，客户端发送退出房间请求（玩家ID、房间ID）
   4.4 服务端验证玩家是否在房间内
   4.5 服务端将该玩家标记为"已弃牌"
   4.6 服务端向房间内所有玩家广播玩家弃牌消息（玩家ID）
   4.7 客户端标记该玩家为"已弃牌"状态
   4.8 服务端判断游戏是否结束（剩余1人）
   4.9 如果游戏结束，服务端触发结算流程
   4.10 如果游戏未结束，服务端继续游戏流程
   4.11 服务端返回退出成功
   4.12 客户端跳转到游戏大厅

**2.6.3 玩家断线重连流程**
**流程步骤：**
1. 玩家重新登录系统
2. 服务端验证玩家Token
3. 服务端判断玩家是否有未完成的房间会话
4. 如果没有未完成的房间会话，流程结束
5. 服务端获取房间信息
6. 服务端判断房间是否存在
7. 如果房间不存在，服务端返回房间已关闭消息
8. 如果房间存在，服务端判断房间游戏状态
9. 如果游戏状态为"等待中"：
   9.1 服务端将玩家重新加入房间玩家列表
   9.2 服务端为玩家分配座位号（原座位号如果空闲则使用，否则分配新座位号）
   9.3 服务端向房间内所有玩家广播玩家重连消息（玩家ID、昵称、座位号）
   9.4 服务端返回房间信息（房间ID、房间状态、玩家列表、游戏信息）
   9.5 客户端跳转到房间界面
   9.6 客户端更新房间信息显示
10. 如果游戏状态为"进行中"：
   10.1 服务端判断玩家是否已弃牌
   10.2 如果玩家已弃牌，服务端返回观战模式
   10.3 如果玩家未弃牌，服务端将玩家标记为"在线"状态
   10.4 服务端取消离线超时计时器
   10.5 服务端向房间内所有玩家广播玩家重连消息（玩家ID、昵称）
   10.6 服务端返回游戏信息（局ID、玩家手牌、注池、单注、轮次、当前玩家）
   10.7 客户端跳转到房间界面
   10.8 客户端显示游戏状态（手牌、注池、轮次等）
   10.9 客户端恢复游戏界面

**2.6.4 房主转移流程**
**流程步骤：**
1. 服务端检测到房主退出房间或断开连接
2. 服务端判断房间是否还有其他玩家
3. 如果房间没有其他玩家，服务端删除房间记录
4. 如果房间有其他玩家，服务端选择新房主（玩家列表中下一位玩家）
5. 服务端更新房间记录（房主ID）
6. 服务端向房间内所有玩家广播房主转移消息（新房主ID、昵称）
7. 客户端更新房主标识显示
8. 客户端为新房主显示"邀请好友"和"开始游戏"按钮

**2.6.5 房间销毁流程**
**流程步骤：**
1. 服务端检测到房间需要销毁（所有玩家退出 或 房间结算完成）
2. 服务端判断房间是否有未完成的游戏
3. 如果有未完成的游戏，服务端触发游戏结算流程
4. 服务端计算每个玩家的净收益（最终游戏币 - 初始游戏币）
5. 服务端将净收益加到玩家实际金币
6. 服务端更新玩家金币记录
7. 服务端记录房间日志（房间ID、所有玩家、游戏记录、结算结果）
8. 服务端向所有玩家广播房间关闭消息
9. 服务端将房间记录归档（保存到数据库）
10. 服务端从Redis中删除房间记录
11. 客户端显示"房间已关闭"提示
12. 客户端跳转到游戏大厅

#### 3. 房间系统

##### 3.1 独立建房流程
**流程步骤：**
1. 玩家在游戏大厅点击"创建房间"按钮
2. 客户端显示建房界面
3. 玩家设置房间参数：
   - 单注倍数（1倍/2倍/5倍）
   - 房间局数（10局/20局/50局）
4. 玩家点击"创建"按钮
5. 客户端发送建房请求（玩家ID、单注倍数、房间局数）
6. 服务端生成房间ID（6位数字，不重复）
7. 服务端创建房间记录（房间ID、创建者ID、单注倍数、房间局数、当前局数、玩家列表、创建时间）
8. 服务端将玩家添加到房间玩家列表
9. 服务端为玩家分配座位号1（房主）
10. 服务端为玩家初始化房间内游戏币（0）
11. 服务端设置房间状态为"等待中"
12. 服务端返回建房成功（房间ID、房间信息）
13. 客户端跳转到房间界面
14. 客户端显示房间信息（房间号、单注倍数、房间局数）
15. 客户端显示玩家列表（房主）
16. 客户端显示"邀请好友"和"开始游戏"按钮（仅房主可见）

**房间数据结构：**
```json
{
  "roomId": "123456",
  "creatorId": "玩家ID",
  "baseBet": 100,
  "totalRounds": 20,
  "currentRound": 0,
  "status": "waiting",
  "players": [
    {
      "playerId": "玩家ID",
      "seatNumber": 1,
      "nickname": "玩家昵称",
      "avatar": "头像URL",
      "roomCoins": 0,
      "isCreator": true,
      "isFolded": false,
      "hasSeenCards": false
    }
  ],
  "createTime": "2025-01-01 12:00:00",
  "gameId": null
}
```

##### 3.2 房间搜索与加入流程
**流程步骤：**
1. 玩家在游戏大厅点击"加入房间"按钮
2. 客户端显示加入房间界面
3. 玩家输入6位房间号
4. 玩家点击"搜索"按钮
5. 客户端发送搜索房间请求（房间号）
6. 服务端验证房间号格式（6位数字）
7. 服务端查询房间记录
8. 服务端判断房间是否存在
9. 如果房间不存在，返回"房间不存在"错误
10. 如果房间存在，服务端验证房间状态
11. 如果房间状态为"游戏中"，返回"房间游戏中，请稍后再试"错误
12. 如果房间状态为"已关闭"，返回"房间已关闭"错误
13. 如果房间状态为"等待中"，服务端验证房间是否已满（最多6人）
14. 如果房间已满，返回"房间已满"错误
15. 如果房间未满，服务端将玩家添加到房间玩家列表
16. 服务端为玩家分配座位号（2-6）
17. 服务端为玩家初始化房间内游戏币（0）
18. 服务端向房间内所有玩家广播玩家加入消息（玩家ID、座位号、昵称、头像）
19. 服务端返回加入成功（房间信息）
20. 客户端跳转到房间界面
21. 客户端显示房间信息（房间号、单注倍数、房间局数）
22. 客户端显示玩家列表（所有玩家）
23. 客户端显示"邀请好友"按钮

**异常处理：**
- 房间号格式错误：提示"请输入6位数字房间号"
- 房间不存在：提示"房间不存在"
- 房间游戏中：提示"房间游戏中，请稍后再试"
- 房间已关闭：提示"房间已关闭"
- 房间已满：提示"房间已满"
- 网络错误：提示"网络连接失败，请稍后重试"

##### 3.3 房间局数设定和自动结算流程
**流程步骤：**
1. 房主创建房间时设置房间局数（10局/20局/50局）
2. 服务端记录房间总局数
3. 服务端初始化当前局数为0
4. 每局游戏结束时，服务端增加当前局数
5. 服务端判断当前局数是否达到总局数
6. 如果未达到总局数，服务端开始下一局
7. 如果达到总局数，服务端触发房间结算流程
8. 服务端计算每个玩家的净收益（最终游戏币 - 初始游戏币0）
9. 服务端按净收益从高到低排序
10. 服务端向所有玩家广播房间结算消息（所有玩家净收益、排名）
11. 客户端显示房间结算界面（玩家排名、净收益）
12. 客户端显示"返回大厅"按钮
13. 服务端设置房间状态为"已关闭"
14. 服务端将房间记录归档（保存到数据库）
15. 服务端从Redis中删除房间记录

##### 3.4 房间内游戏币独立系统
**流程步骤：**
1. 玩家加入房间时，服务端为玩家初始化房间内游戏币（0）
2. 服务端在房间内使用游戏币进行游戏（跟注、加注、比牌、结算）
3. 游戏结算时，服务端计算玩家游戏币变化
4. 房间结算时，服务端计算玩家净收益（最终游戏币 - 初始游戏币0）
5. 服务端向玩家广播金币变化消息

**金币计算示例：**
- 玩家加入房间，分配游戏币：0
- 房间结算时，玩家游戏币：20000
- 净收益：20000 - 0 = 20000

#### 4. 技术架构

##### 4.1 客户端基础框架（Phaser）
**技术栈：**
- 游戏引擎：Phaser 3.60+
- UI框架：Phaser UI Plugin
- 通信协议：WebSocket
- 状态管理：Phaser Data Manager

**核心模块：**
- 游戏场景管理器（SceneManager）
- 资源加载器（AssetLoader）
- UI组件库（Button、Card、PlayerAvatar、Chips等）
- 网络通信模块（WebSocketClient）
- 动画管理器（AnimationManager）
- 音效管理器（AudioManager）

##### 4.2 服务端基础框架（Node.js + WebSocket）
**技术栈：**
- 运行时：Node.js 18+
- WebSocket库：Socket.io 4.x
- 数据库：MongoDB 6.x + Redis 7.x
- 日志系统：Winston
- 监控系统：Prometheus + Grafana

**核心模块：**
- WebSocket服务器（SocketServer）
- 游戏逻辑处理器（GameLogic）
- 房间管理器（RoomManager）
- 用户管理器（UserManager）
- 数据访问层（DAO）
- 日志记录器（Logger）

##### 4.3 数据库设计

**MongoDB集合设计：**
1. users（用户表）
   - userId: String（主键）
   - phone: String（手机号，唯一索引）
   - password: String（加密密码）
   - deviceId: String（设备ID）
   - nickname: String（昵称）
   - avatar: String（头像URL）
   - coins: Number（金币）
   - createTime: Date（创建时间）
   - lastLoginTime: Date（最后登录时间）
   - totalGames: Number（总游戏数）
   - totalWins: Number（总胜局）

2. game_logs（游戏日志表）
   - gameId: String（游戏ID，主键）
   - roomId: String（房间ID）
   - players: Array（玩家列表）
   - actions: Array（操作记录）
   - winnerId: String（获胜玩家ID）
   - pot: Number（注池）
   - rake: Number（抽水）
   - createTime: Date（创建时间）

3. room_logs（房间日志表）
   - roomId: String（房间ID，主键）
   - creatorId: String（创建者ID）
   - totalRounds: Number（总局数）
   - players: Array（玩家列表）
   - results: Array（结算结果）
   - createTime: Date（创建时间）
   - endTime: Date（结束时间）

**Redis数据结构设计：**
1. rooms（房间信息，Hash）
   - key: room:{roomId}
   - fields: 房间信息JSON

2. games（游戏信息，Hash）
   - key: game:{gameId}
   - fields: 游戏信息JSON

3. user_sessions（用户会话，String）
   - key: session:{userId}
   - value: Token

4. verification_codes（验证码，String，过期时间5分钟）
   - key: code:{phone}
   - value: 验证码
   - 说明：一期暂不实现，二期接入短信服务后启用

##### 4.4 基础监控和日志系统

**日志系统：**
- 日志级别：DEBUG、INFO、WARN、ERROR
- 日志分类：access（访问日志）、game（游戏日志）、error（错误日志）
- 日志格式：时间戳、日志级别、日志分类、日志内容
- 日志存储：本地文件 + MongoDB

**监控系统：**
- 监控指标：
  - 在线用户数
  - 房间数量
  - 游戏局数
  - API响应时间
  - 错误率
  - CPU使用率
  - 内存使用率
- 告警规则：
  - 错误率 > 1%
  - API响应时间 > 1秒
  - CPU使用率 > 80%
  - 内存使用率 > 80%

### 验证指标
- 完整游戏流程可跑通（注册 -> 登录 -> 建房 -> 入桌 -> 游戏 -> 结算）
- 单局时长控制在30-90秒
- 基础防作弊机制有效（服务端发牌、牌型判断、结算）
- 独立建房和加入房间功能正常
- 房间内游戏币独立于金币系统，仅在房间内生效
- 房间局数设定和自动结算功能正常
- 同设备防多开机制有效
- 系统稳定性：可用性≥99.5%

## 第二期：功能扩展与优化
### 目标
在核心功能基础上进行扩展和优化，提升用户体验，增强游戏粘性。

### 功能列表
#### 1. 用户系统升级
- 短信验证码功能
  - 接入第三方短信服务
  - 注册时发送验证码
  - 验证码有效期控制（5分钟）
  - 验证码错误次数限制
- 用户等级系统
- 基础成就系统

#### 2. 游戏体验优化
- 游戏动画和特效优化
- 音效系统
- 游戏设置（音量、画质等）
- 断线重连机制

#### 3. 经济系统扩展
- VIP系统（月卡）
  - 抽水减免特权
  - 每日额外补助
- 更丰富的商城商品
  - 表情包
  - 头像框
  - 特殊称号

#### 4. 机器人系统优化
- 多级AI（保守/激进/随机）
- 可控胜率区间
- 更智能的决策算法

#### 5. 数据统计与分析
- 用户行为数据收集
- 游戏数据统计面板
- 核心指标监控（留存、ARPU等）

### 验证指标
- 用户注册转化率提升
- 用户平均游戏时长增加
- 付费转化率提升
- 用户满意度调查结果改善

## 第三期：社交与竞技功能
### 目标
增加社交互动和竞技元素，提升用户粘性和平台活跃度。

### 功能列表
#### 1. 社交系统
- 好友系统
  - 好友添加/删除
  - 好友在线状态
  - 好友游戏邀请
- 私人房功能
  - 创建私人房间
  - 邀请好友加入
  - 自定义房间规则

#### 2. 竞技系统
- 排行榜系统
  - 财富榜
  - 胜局榜
  - 等级榜
- 比赛模式
  - 定时锦标赛
  - 入场费机制
  - 奖励分配机制

#### 3. 活动系统
- 日常任务
  - 登录奖励
  - 游戏局数奖励
  - 胜局奖励
- 限时活动
  - 节日主题活动
  - 冲榜活动
  - 充值返利活动

#### 4. 消息系统
- 系统通知
- 好友消息
- 游戏内聊天

### 验证指标
- 用户日均互动次数提升
- 用户留存率提升
- 活跃用户数增长
- 用户参与活动的比例提升

## 第四期：平台化与多元化发展
### 目标
实现平台化架构，支持多玩法扩展，建立跨玩法资产体系。

### 功能列表
#### 1. 新玩法扩展
- 德州扑克开发
  - 完整规则实现
  - 独立房间系统
  - 适配经济系统
- 牛牛开发
  - 完整规则实现
  - 独立房间系统
  - 适配经济系统

#### 2. 跨玩法资产体系
- 统一货币系统
  - 各游戏间金币通用
  - 跨游戏代币兑换机制
- 统一成就系统
  - 跨游戏成就累计
  - 全平台排行榜
- 统一社交系统
  - 跨游戏好友互动
  - 全平台私信系统

#### 3. 平台功能完善
- 统一大厅升级
  - 游戏入口统一管理
  - 全平台公告系统
  - 活动中心
- 数据分析平台
  - 用户画像分析
  - 游戏平衡性分析
  - 商业数据分析

#### 4. 技术架构升级
- 微服务架构改造
  - 用户服务独立
  - 经济服务独立
  - 游戏服务独立
- 容器化部署
  - Docker化部署
  - Kubernetes集群管理
- 性能优化
  - 数据库读写分离
  - 缓存策略优化
  - CDN加速

### 验证指标
- 平台月活用户数增长
- 跨游戏代币流通量
- 新玩法用户接受度
- 系统稳定性指标（可用性≥99.9%）

## 总结
通过这四个阶段的迭代开发，我们将逐步构建一个功能完善、用户体验优良、具备竞争力的牌类游戏平台。每个阶段都有明确的目标和可衡量的指标，确保项目稳步推进并及时调整方向。