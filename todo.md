# 炸金花比牌流程设计说明

## 一、比牌触发条件

### 1.1 前置条件
- 游戏状态必须为 `playing`
- 发起比牌的玩家状态为 `playing`（未弃牌、未输）
- 目标玩家状态为 `playing`
- 当前轮到发起比牌的玩家操作

### 1.2 比牌时机
- 在任何下注轮次中，玩家都可以选择比牌
- 比牌是主动操作，需要玩家明确选择比牌目标

## 二、比牌验证阶段

### 2.1 验证逻辑
1. 验证游戏是否存在且状态正常
2. 验证发起玩家是否在游戏中且状态允许
3. 验证目标玩家是否在游戏中且状态允许
4. 验证发起玩家是否为当前操作玩家
5. 验证发起玩家与目标玩家不是同一人

## 三、比牌执行流程

### 3.1 核心比牌逻辑
```
比牌流程：
1. 获取两个玩家的手牌
2. 调用 compareHands() 比较牌型
3. 判断胜负：
   - result > 0: 发起玩家赢
   - result < 0: 目标玩家赢
   - result = 0: 平局（根据规则处理）
```

### 3.2 牌型比较规则

#### 牌型优先级（从高到低）
1. 豹子 (THREE) - 价值: 6000 + 最大点数
2. 同花顺 (FULL_HOUSE) - 价值: 5000 + 最大点数
3. 同花 (FLUSH) - 价值: 4000 + 点数组合
4. 顺子 (STRAIGHT) - 价值: 3000 + 最大点数
5. 对子 (PAIR) - 价值: 2000 + 对子点数*100 + 单张点数
6. 单张 (SINGLE) - 价值: 点数组合

#### 同牌型比较规则
- 比较最大牌的点数
- 点数相同比较花色（黑桃 > 红桃 > 梅花 > 方块）

## 四、比牌结果处理

### 4.1 胜负判定

#### 当前代码实现
)

### 4.2 玩家状态更新

#### 输家状态变更
- status: playing → lost
- hasActedThisRound: true
- 保留 totalBet（已下注金额）
- 保留 cards（手牌信息，用于结算展示）

#### 赢家状态
- status: playing（保持不变）
- hasActedThisRound: true

## 五、游戏状态流转

### 5.1 活跃玩家检查

```javascript
// 检查剩余活跃玩家数量
const activePlayers = game.players.filter(
  (p) => p.status === PLAYER_STATUS.PLAYING
);

if (activePlayers.length <= 1) {
  // 只剩一个玩家，游戏结束
  game.status = GAME_STATUS.SETTLED;
  await endGame(gameId);
} else {
  // 还有多个玩家，继续游戏
  moveToNextPlayer(game);
}
```

### 5.2 游戏继续流程

```
比牌后游戏继续：
1. 移动到下一个玩家
2. 重置当前轮次下注标记（如果需要）
3. 检查下注轮次是否完成
4. 更新游戏状态
5. 保存游戏数据
```

## 六、玩家通知机制

### 6.1 Socket事件推送

```javascript
// 为每个玩家单独发送游戏状态更新
for (const player of room.players) {
  const playerSocket = userSockets.get(playerId);
  if (playerSocket) {
    // 发送格式化后的游戏数据
    const playerGame = gameService.formatGame(result, player.userId);
    playerSocket.emit("game_state_update", playerGame);
  }
}
```

### 6.2 通知内容

#### game_state_update 事件包含
- 游戏基本信息（房间ID、当前局数、状态）
- 底池金额
- 当前玩家索引
- 所有玩家信息（包括状态、手牌、下注额）
- 比牌结果（隐含在玩家状态中）

## 七、比牌关键细节

### 7.1 数据一致性
- 比牌后必须立即保存游戏状态
- 玩家金币更新需要同步到房间数据
- 避免并发操作导致的状态冲突

### 7.2 安全性考虑
- 验证操作者身份，防止作弊
- 验证操作时机，防止非法操作
- 隐藏其他玩家手牌（除非游戏结束）
- 记录操作日志，便于审计

### 7.3 用户体验
- 比牌前显示可比牌的玩家列表
- 比牌后立即显示比牌结果（动画效果）
- 输家手牌在比牌后显示给所有玩家
- 提供清晰的状态提示（"XX比牌XX，XX获胜"）

### 7.4 边界情况处理
- 玩家金币不足时的比牌处理
- 玩家离线后的比牌处理
- 网络延迟导致的状态同步问题
- 平局情况的特殊处理
- 多个玩家同时比牌的并发控制

## 八、比牌实现清单

### 8.1 必须实现
- [ ] 完善比牌验证逻辑
- [ ] 实现平局处理机制
- [ ] 添加比牌历史记录
- [ ] 优化比牌结果通知
- [ ] 完善错误处理和日志记录

### 8.2 建议实现
- [ ] 比牌动画效果
- [ ] 比牌音效
- [ ] 比牌统计功能
- [ ] 数据一致性保障

### 8.3 可选实现
- [ ] 比牌回放功能
- [ ] 比牌数据分析
- [ ] 比牌策略建议
- [ ] 比牌排行榜
